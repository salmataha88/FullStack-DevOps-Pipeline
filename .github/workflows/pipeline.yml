name: Full-Stack CI/CD Pipeline

on:
  push:
    branches:
      - main
  
  pull_request:
    branches:
      - main
  
  workflow_dispatch:
   inputs:
    environment:
      description: 'Deployment Environment'
      required: true
      default: 'dev'
      type: choice
      options:
        - dev
        - staging
        - production

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  # ========== .NET Backend CI ==============
  dotnet-ci:
    name: Build .NET Backend
    uses: salmataha88/Automation-Workflows/.github/workflows/dotnet.yml@main
    with:
      dotnet-version: '8.0'
      project-Dir: './DotNet-Backend'
      project-path: './DotNet-Backend/API.csproj'
      build-configuration: 'Release'
      run-tests: true

  # ========== React Frontend CI ============
  react-ci:
    name: Build React Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
        working-directory: ./React-Frontend

      - name: Build React app
        run: npm run build
        working-directory: ./React-Frontend

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-dist
          path: React-Frontend/dist/

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: react-dist
          path: dist/
      
      - name: Run GitLeaks for secret detection
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload GitLeaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: gitleaks-react
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-react
      
      - name: Build and Push React Docker Image
        uses: salmataha88/Automation-Workflows/.github/actions/react-docker-s2i@main
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          image-name: react-frontend
          tag: ${{ github.sha }}
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Tag as latest
        run: |
          docker tag ghcr.io/${{ github.actor }}/react-frontend:${{ github.sha }} \
                    ghcr.io/${{ github.actor }}/react-frontend:latest
          docker push ghcr.io/${{ github.actor }}/react-frontend:latest
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: ghcr.io/${{ github.actor }}/react-frontend:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
      
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: trivy-results.sarif
          category: trivy-react

  # ======= Deploy to Dev Environment =======
  deploy-dev:
    if: github.event.inputs.environment == 'dev'
    name: Deploy to Dev (Local)
    runs-on: [self-hosted, linux]
    needs: [dotnet-ci, react-ci]
    environment:
      name: dev
      url: http://localhost:8080
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸš€ Deploy with Ansible
        run: |
          ansible-playbook playbook.yml \
            -e "github_actor=${{ github.actor }}" \
            -e "github_token=${{ secrets.GITHUB_TOKEN }}" \
            -e "mysql_root_password=${{ secrets.MYSQL_ROOT_PASSWORD }}" \
            -e "db_host=${{ vars.DB_HOST }}" \
            -e "db_port=${{ vars.DB_PORT }}" \
            -e "db_name=${{ vars.DB_NAME }}" \
            -e "db_user=${{ vars.DB_USER }}"
      
      - name: Deployment Summary
        run: |
          echo "Dev Deployment Complete!ðŸŽ‰"
          echo "Services:"
          echo "  - Frontend: http://localhost:8080"
          echo "  - Backend: http://localhost:5000"
          echo "  - MySQL: localhost:3306"

  # ====== Deploy React to Railway (Using GHCR Image) ======
  deploy-react-railway:
    if: github.event.inputs.environment != 'dev'
    name: Deploy React to Railway
    runs-on: ubuntu-latest
    needs: [react-ci]
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ vars.RAILWAY_REACT_URL }}
    
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
      
      - name: Deploy React from GHCR
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_REACT_SERVICE_ID }}
          railway variables --set VITE_API_URL=${{ vars.RAILWAY_DOTNET_URL }}
          railway up --detach --image ghcr.io/${{ github.actor }}/react-frontend:${{ github.sha }}

  # ====== Deploy .NET to Railway (Using GHCR Image) ======
  deploy-dotnet-railway:
    if: github.event.inputs.environment != 'dev'
    name: Deploy .NET Backend to Railway
    runs-on: ubuntu-latest
    needs: [dotnet-ci]
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ vars.RAILWAY_DOTNET_URL }}
    
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
      
      - name: Deploy .NET from GHCR
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_DOTNET_SERVICE_ID }}
          railway variables --set ConnectionStrings__DefaultConnection="Server=${{ vars.DB_HOST }};Port=${{ vars.DB_PORT }};Database=${{ vars.DB_NAME }};User=${{ vars.DB_USER }};Password=${{ secrets.MYSQL_ROOT_PASSWORD }};"
          railway up --detach --image ghcr.io/${{ github.actor }}/dotnet-backend:${{ github.sha }}